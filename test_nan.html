<html>
<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
body { font-family: "Open Sans"; } div { margin: 30px; }
svg { border: solid black 1px; }
.axis path { fill: none; stroke: #777; }
.axis line { stroke: #777; }
button {
  border: 2px solid grey;
  background: white;
  padding: 8px 16px;
  color: black;
  font-size: 16px;
  font-family: "Lato", sans-serif;
  text-decoration: none;
  vertical-align: middle;
  margin:4px;
}
#buttonlist1 {
 	position: absolute;
    left: 450px;
    top: 50px;

}
#buttonlist2 {
 	position: absolute;
    left: 450px;
    top: 130px;
}
#buttonlist3 {
 	position: absolute;
    left: 450px;
    top: 175px;
}
p {
	line-height: 30%;
}

</style>
</head>
<body>

<div id="canvas"></div>
<div id="buttonlist1">
<p>Choose time span or frequency:</p>
<button id="years">How many years have been played</button>
</div>
<div id="buttonlist2">
<button id="hours">How many hours a week</button>
</div>
<div id="buttonlist3">
<p>Choose game type:</p>
<button id="rank1">3 VS 3</button>
<button id="rank3">5 VS 5</button>
<button id="rank2">Solo</button>
</div>
<script>
//change these numbers to make it scalable
var svgheight = 450
var svgwidth = 800
var height = 450
var width = 450
var padding = 80
var labelFontSize = 15
var stokeWidth = 5
var dasharray = "10,10"

var users;
var xScale;
var yScale;

var maxYear = 7 //year: 0-6
var maxHour = 5 //hour: 0-4
var maxRank = 8 //rank: 0-7

var svg;
var labels;
var legend;

d3.csv("formatData.csv", function (error, data) {
	users = data;
	
	var defaultX = "years";
	var defaultY = "rank1";
	chooseStyle(defaultX, defaultY);
	d3.select("#years").on("click", function () {
		chooseStyle("years", defaultY);
		defaultX = "years";
	});
	d3.select("#hours").on("click", function () {
		chooseStyle("hours", defaultY);
		defaultX = "hours";
	});
	d3.select("#rank1").on("click", function () {
		chooseStyle(defaultX, "rank1");
		defaultY = "rank1";
	});
	d3.select("#rank2").on("click", function () {
		chooseStyle(defaultX, "rank2");
		defaultY = "rank2";
	});
	d3.select("#rank3").on("click", function () {
		chooseStyle(defaultX, "rank3");
		defaultY = "rank3";
	});
	
});

var chooseStyle = function(xx, yy){
	d3.select("#canvas").select("svg").remove();
	svg = d3.select("#canvas").append("svg")
			.attr("height", svgheight)
			.attr("width", svgwidth);
	labels = svg.append("g").attr("class", "labels");
	legend = svg.append("g").attr("class", "legend");
	if( xx == "years"){ setXYscale(maxYear, maxRank) }
	else{ setXYscale(maxHour, maxRank) }
	drawSquares(xx,yy)		
	setXLabel(xx)
	setYLabel("rank")	
	creatLine(xx, yy)
	addLegend(xx);
}
var setXYscale = function(xx, yy){
	xScale = d3.scale.linear().domain([0,xx])
	.range([padding, width-padding]);
	yScale = d3.scale.linear().domain([0, yy])
	.range([height-padding,padding]);

	var xAxis = d3.svg.axis().scale(xScale)
	.orient("bottom");
	var yAxis = d3.svg.axis().scale(yScale)
	.orient("left");
	
	svg.append("g").attr("class", "axis")
	.attr("transform", "translate(0," + (width - padding) + ")")
	.call(xAxis);
	svg.append("g").attr("class", "axis")
	.attr("transform", "translate(" + padding + ",0)")
	.call(yAxis);
}

var setXLabel = function(tt){
	labels.append("text")						
		.attr("x", width-padding/2)
		.attr("y", height-padding)
		.attr("font-size", labelFontSize)
		.attr("text-anchor", "middle")		
		.text(tt);
}

var setYLabel = function(tt){
	labels.append("text")
		.attr("x", padding*3/4)
		.attr("y", padding*3/4)
		.attr("font-size", labelFontSize)
		.attr("text-anchor", "middle")
		.text(tt);
}

var drawSquares = function(xx, yy){
	var squares = svg.selectAll("rect").data(users)
		.enter().append("rect");
	if(xx == "years"){
		squares.attr("x", function(d) { return xScale(d.years) })
			.attr("width", function(d) { return (width-padding-padding)/(maxYear+1) })		
	}else{
		squares.attr("x", function(d) { return xScale(d.hours) })
		.attr("width", function(d) { return (width-padding-padding)/(maxHour+1) })
	}
	if(yy == "rank1"){
		squares.attr("y", function(d) { return yScale(d.rank1) })
	}else if (yy == "rank2"){
		squares.attr("y", function(d) { return yScale(d.rank2) })
	}else{
		squares.attr("y", function(d) { return yScale(d.rank3) })
	}

	squares.attr("rx", width/50).attr("ry", height/50)
		.attr("height", function(d) { return (height-padding-padding)/(maxRank+1) })
		.attr("transform", "translate(0,"+ -(height-padding-padding)/(maxRank+1) + ")" )
		.attr("opacity", 0.1);
		

	switch (yy){
		case "rank1":
			squares.attr("fill", "green"); break;
		case "rank2":
			squares.attr("fill", "purple"); break;
		case "rank3":
			squares.attr("fill", "blue"); break;
	}
}

var creatLine = function(xx, yy){
	var model = {};
	var meanX;
	var meanY;
	
	if(xx == "years" && yy == "rank1"){
		meanX = d3.mean(users, function (d) { return d.years;});
		meanY = d3.mean(users, function (d) { return d.rank1;});
		model.slope = d3.sum(users, function (d) {
			return (d.years - meanX) * (d.rank1 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.years - meanX) * (d.years - meanX);
		});
	}else if (xx == "years" && yy == "rank2"){
		meanX = d3.mean(users, function (d) { return d.years;});
		meanY = d3.mean(users, function (d) { return d.rank2;});
		model.slope = d3.sum(users, function (d) {
			return (d.years - meanX) * (d.rank2 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.years - meanX) * (d.years - meanX);
		});
	}else if (xx == "years" && yy == "rank3"){
		meanX = d3.mean(users, function (d) { return d.years;});
		meanY = d3.mean(users, function (d) { return d.rank3;});
		model.slope = d3.sum(users, function (d) {
			return (d.years - meanX) * (d.rank3 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.years - meanX) * (d.years - meanX);
		});
	}else if (xx == "hours" && yy == "rank1"){
		meanX = d3.mean(users, function (d) { return d.hours;});
		meanY = d3.mean(users, function (d) { return d.rank1;});
		model.slope = d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.rank1 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.hours - meanX);
		});
	}else if (xx == "hours" && yy == "rank2"){
		meanX = d3.mean(users, function (d) { return d.hours;});
		meanY = d3.mean(users, function (d) { return d.rank2;});
		model.slope = d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.rank2 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.hours - meanX);
		});
	}else{
		meanX = d3.mean(users, function (d) { return d.hours;});
		meanY = d3.mean(users, function (d) { return d.rank3;});
		model.slope = d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.rank3 - meanY);
		});
		model.slope /= d3.sum(users, function (d) {
			return (d.hours - meanX) * (d.hours - meanX);
		});
	}

	model.intercept = meanY - model.slope * meanX;
	var regressionLine = svg.append("line")
							.attr("x1", xScale(0))
							.attr("y1", yScale(model.slope * 0 + model.intercept))
							.style("stroke", "black")
							.style("stroke-width", stokeWidth)
							.style("stroke-dasharray", dasharray);

	if(xx == "years"){
		regressionLine.attr("x2", xScale(maxYear))
					.attr("y2", yScale(model.slope * maxYear + model.intercept))
	}else{
		regressionLine.attr("x2", xScale(maxHour))
					.attr("y2", yScale(model.slope * maxHour+ model.intercept))
	}
}


	var addLegend = function(xx) {
		// Add legend	
		var newwidth = width;
		var newheight = height-padding*2.2;

		//legend for ranks
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding/4)
				.attr("font-size", 13)
				.attr("alignment-baseline", "middle")
				.text("Rank:");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*3/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("7-8: Challenger");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*4/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("6-7: Masters");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*5/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("5-6: Diamond");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*6/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("4-5: Platinum");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("3-4: Gold");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*8/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("2-3: Silver");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*9/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("1-2: Bronze");
		legend.append("text")
				.attr("x", newwidth)
				.attr("y", newheight + padding*10/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("0-1: Unranked");

		//legend for years
		if (xx == "years"){
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding/4)
				.attr("font-size", 13)
				.attr("alignment-baseline", "middle")
				.text("How long have been played:");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*3/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("0-1: Less than 6 months");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*4/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("1-2: 6 months to 1 year");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*5/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("2-3: 1-2 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*6/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("3-4: 2-3 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("4-5: 3-4 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*8/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("5-6: 4-5 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*9/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("6-7: 5+ years");
		}else{
			//legend for hours
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding/4)
				.attr("font-size", 13)
				.attr("alignment-baseline", "middle")
				.text("How many hours a week:");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*3/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("0-1: 5 hours or less");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*4/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("1-2: 5-10 hours");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*5/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("2-3: 10-15 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding*6/7)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("3-4: 15-20 years");
		legend.append("text")
				.attr("x", newwidth + newwidth/4)
				.attr("y", newheight + padding)
				.attr("font-size", 12)
				.attr("alignment-baseline", "middle")
				.text("4-5: More than 20 hours");
		}

	}

</script>

</body>
</html>
